# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö CES —Ç–æ–∫–µ–Ω–æ–≤ –≤ —ç—Å–∫—Ä–æ—É

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–î–∞—Ç–∞:** 25 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** –ê–ª–µ–∫—Å–µ–π (942851377) - `0x1A1432d6D4eFe75651f2c39DC1Ec6a5D936f401d`  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–ø–∞–ª–∏ 2 CES —Ç–æ–∫–µ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Å—Ç—Ä—è–ª–∏ –≤ —ç—Å–∫—Ä–æ—É –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞ –º–µ–π–∫–µ—Ä–æ–º

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **–ë–∞–ª–∞–Ω—Å –±–ª–æ–∫—á–µ–π–Ω–∞:** 2.0000 CES
2. **–ë–∞–ª–∞–Ω—Å –≤ –ë–î –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2 CES –¥–æ—Å—Ç—É–ø–Ω–æ + 2 CES –≤ —ç—Å–∫—Ä–æ—É = 4 CES –æ–±—â–∏–π
3. **–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:** -2.0000 CES (–ë–î –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ –Ω–∞ 2 CES –±–æ–ª—å—à–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏)

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:
- –§—É–Ω–∫—Ü–∏—è `cancelOrder` –≤ `src/services/p2pService.js` –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–ª–∞ —Ç–æ–∫–µ–Ω—ã –∏–∑ —ç—Å–∫—Ä–æ—É –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ sell –æ—Ä–¥–µ—Ä–æ–≤
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ—Ä–¥–µ—Ä–∞ –º–µ–π–∫–µ—Ä–æ–º —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–ª–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞ 'cancelled', –Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ CES —Ç–æ–∫–µ–Ω—ã

## ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–°–∫—Ä–∏–ø—Ç:** `scripts/fix-stuck-escrow.js`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å: 2 CES ‚Üí 0 CES
- –≠—Å–∫—Ä–æ—É –±–∞–ª–∞–Ω—Å: 2 CES ‚Üí 2 CES (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫)
- –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: 4 CES ‚Üí 2 CES (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–ª–æ–∫—á–µ–π–Ω—É)

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ cancelOrder

**–§–∞–π–ª:** `src/services/p2pService.js`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞:**
```javascript
// –î–ª—è sell –æ—Ä–¥–µ—Ä–æ–≤: –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ —ç—Å–∫—Ä–æ—É
if (order.type === 'sell' && order.escrowLocked && order.escrowAmount > 0) {
  await escrowService.refundTokensFromEscrow(
    user._id,
    null,
    'CES',
    order.escrowAmount,
    'Sell order cancelled by maker'
  );
}

// –î–ª—è buy –æ—Ä–¥–µ—Ä–æ–≤: –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä—É–±–ª–µ–≤—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤
if (order.type === 'buy') {
  await rubleReserveService.releaseOrderReserve(
    user._id.toString(),
    orderId
  );
}
```

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚úÖ EscrowService —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –§—É–Ω–∫—Ü–∏—è refundTokensFromEscrow –¥–æ—Å—Ç—É–ø–Ω–∞
- ‚úÖ RubleReserveService —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω  
- ‚úÖ –§—É–Ω–∫—Ü–∏—è releaseOrderReserve –¥–æ—Å—Ç—É–ø–Ω–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∞

### –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤:
- **–†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å CES (–±–ª–æ–∫—á–µ–π–Ω):** 2.0000 CES
- **–ë–∞–ª–∞–Ω—Å CES –≤ –ë–î:** 0 CES (–¥–æ—Å—Ç—É–ø–Ω–æ)
- **–≠—Å–∫—Ä–æ—É CES –≤ –ë–î:** 2 CES (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫)
- **–û–±—â–∏–π –≤ –ë–î:** 2 CES
- **–†–∞–∑–Ω–∏—Ü–∞ (–±–ª–æ–∫—á–µ–π–Ω - –ë–î):** 0.0000 CES ‚úÖ

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏:
1. **–°–¥–µ–ª–∫–∞ 68ac835142519086c23184e4:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1 CES  
   - –°—Ç–∞—Ç—É—Å: payment_pending
   - –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ü—Ä–æ–¥–∞–≤–µ—Ü

2. **–°–¥–µ–ª–∫–∞ 68aca0cbe999f76459dd64bf:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1 CES
   - –°—Ç–∞—Ç—É—Å: payment_pending  
   - –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ü—Ä–æ–¥–∞–≤–µ—Ü

**–ò—Ç–æ–≥–æ –≤ —ç—Å–∫—Ä–æ—É:** 2 CES (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

## üõ°Ô∏è –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è

### –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è cancelOrder** - —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —ç—Å–∫—Ä–æ—É
2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø—Ä–∏ —Å–±–æ—è—Ö –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
4. **–†–∞–∑–¥–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - sell –∏ buy –æ—Ä–¥–µ—Ä–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã:
- `scripts/diagnose-stuck-escrow.js` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —ç—Å–∫—Ä–æ—É
- `scripts/fix-stuck-escrow.js` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤
- `scripts/test-order-cancellation-fix.js` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## üìù –í—ã–≤–æ–¥—ã

1. **–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é** - –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–≤–µ–¥–µ–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º
2. **–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞** - —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
3. **–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–µ–Ω–∞** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ä—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–ª—É—á—à–µ–Ω** - —Å–æ–∑–¥–∞–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–ª–æ–∫—á–µ–π–Ω—É
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç—Å–∫—Ä–æ—É** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã** —Ñ—É–Ω–∫—Ü–∏–π –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–æ–≤
4. **Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–û  
**–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è:** 25 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** –°–∏—Å—Ç–µ–º–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è