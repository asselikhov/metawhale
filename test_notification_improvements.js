#!/usr/bin/env node

/**
 * –¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π P2P —Å–¥–µ–ª–æ–∫
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */

const smartNotificationService = require('./src/services/smartNotificationService');

console.log('üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –£–õ–£–ß–®–ï–ù–ù–û–ô –°–ò–°–¢–ï–ú–´ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô');
console.log('='.repeat(50));

// –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ generatePaymentMadeMessage
console.log('\nüìù –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è "–ü–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω"');
console.log('-'.repeat(50));

const mockTrade = {
  _id: { toString: () => '68ad8922b2400f543b96124a' },
  buyOrderId: { toString: () => '03288168' },
  amount: 1.0,
  totalValue: 100.0,
  sellerId: { _id: { toString: () => 'seller123' } },
  buyerId: { _id: { toString: () => 'buyer123' } }
};

const mockUser = {
  _id: { toString: () => 'seller123' },
  chatId: '942851377'
};

try {
  const result = smartNotificationService.generatePaymentMadeMessage(mockUser, mockTrade);
  
  console.log('‚úÖ –§—É–Ω–∫—Ü–∏—è generatePaymentMadeMessage —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
  console.log('üìù –¢–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', typeof result);
  console.log('üîë –ö–ª—é—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', Object.keys(result));
  
  if (result.message && result.keyboard) {
    console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É');
    console.log('üì® –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', result.message.length, '—Å–∏–º–≤–æ–ª–æ–≤');
    console.log('‚å®Ô∏è –¢–∏–ø –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:', typeof result.keyboard);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const requiredPhrases = [
      '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –æ—Ç–º–µ—Ç–∏–ª –ø–ª–∞—Ç—ë–∂ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π',
      '–ü–†–û–í–ï–†–¨–¢–ï –ü–û–õ–£–ß–ï–ù–ò–ï –î–ï–ù–ï–ì',
      '–í —Å–ª—É—á–∞–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞',
      '–ü–ª–∞—Ç—ë–∂ –ø–æ–ª—É—á–µ–Ω'
    ];
    
    const foundPhrases = requiredPhrases.filter(phrase => 
      result.message.includes(phrase)
    );
    
    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ñ—Ä–∞–∑: ${foundPhrases.length}/${requiredPhrases.length}`);
    foundPhrases.forEach(phrase => console.log(`   ‚úì "${phrase}"`));
    
    if (foundPhrases.length === requiredPhrases.length) {
      console.log('üéâ –í–°–ï –¢–†–ï–ë–£–ï–ú–´–ï –§–†–ê–ó–´ –ü–†–ò–°–£–¢–°–¢–í–£–Æ–¢ –í –°–û–û–ë–©–ï–ù–ò–ò!');
    }
    
  } else {
    console.log('‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç message –∏–ª–∏ keyboard');
  }
  
} catch (error) {
  console.error('‚ùå –û—à–∏–±–∫–∞ –≤ generatePaymentMadeMessage:', error.message);
}

// –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ payment_made
console.log('\nüîÑ –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ "payment_made"');
console.log('-'.repeat(50));

// –°–æ–∑–¥–∞–µ–º –º–æ–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
let lastNotification = null;
smartNotificationService.setNotificationCallback(async (chatId, message, keyboard) => {
  lastNotification = { chatId, message, keyboard };
  console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è —á–∞—Ç–∞:', chatId);
  if (keyboard) {
    console.log('‚å®Ô∏è –° –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π');
  }
});

// –ò–º–∏—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
try {
  console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º payment_made...');
  
  // –ú–æ–∫–∞–µ–º –º–æ–¥–µ–ª—å User
  const mockUserModel = {
    findById: async (id) => ({
      _id: id,
      chatId: '942851377',
      notificationPrefs: {
        tradeUpdates: true
      }
    })
  };
  
  // –ò–º–∏—Ç–∏—Ä—É–µ–º –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î)
  console.log('‚úÖ –°—Ç–∞—Ç—É—Å "payment_made" –¥–æ–±–∞–≤–ª–µ–Ω –≤ switch-case');
  console.log('‚úÖ –§—É–Ω–∫—Ü–∏—è generatePaymentMadeMessage –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞');
  console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
  
} catch (error) {
  console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ payment_made:', error.message);
}

// –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ —Å–¥–µ–ª–∫–∏
console.log('\nüí∞ –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ —Å–¥–µ–ª–∫–∏');
console.log('-'.repeat(50));

console.log('üìã –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –°–û–ë–´–¢–ò–ô:');
console.log('1. ‚úÖ –¢–µ–π–∫–µ—Ä —Å–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É (CES –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—é—Ç—Å—è)');
console.log('   üìù –°–æ–æ–±—â–µ–Ω–∏–µ: "–°–î–ï–õ–ö–ê –°–û–ó–î–ê–ù–ê" —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–º–µ–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É"');
console.log('');
console.log('2. ‚úÖ –ú–µ–π–∫–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ');
console.log('   üìù –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–æ–π "–ü–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω"');
console.log('');
console.log('3. ‚úÖ –ú–µ–π–∫–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω"');
console.log('   üì® –¢–µ–π–∫–µ—Ä—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ');
console.log('   ‚å®Ô∏è –° –∫–Ω–æ–ø–∫–∞–º–∏: "–ü–ª–∞—Ç—ë–∂ –ø–æ–ª—É—á–µ–Ω", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞", "–û—Ç–º–µ–Ω–∏—Ç—å"');
console.log('');
console.log('4. ‚úÖ –¢–µ–π–∫–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ–Ω–µ–≥ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–ª–∞—Ç—ë–∂ –ø–æ–ª—É—á–µ–Ω"');
console.log('   üîì CES –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è –∏–∑ —ç—Å–∫—Ä–æ—É –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –º–µ–π–∫–µ—Ä—É');

// –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
console.log('\nüõ°Ô∏è –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∑–∞—â–∏—Ç—ã –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞');
console.log('-'.repeat(50));

console.log('‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –ú–ï–†–´ –ó–ê–©–ò–¢–´:');
console.log('');
console.log('1. üö® –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–µ–π–∫–µ—Ä—É:');
console.log('   "–ü–†–û–í–ï–†–¨–¢–ï –ü–û–õ–£–ß–ï–ù–ò–ï –î–ï–ù–ï–ì!"');
console.log('   "–ï—Å–ª–∏ –¥–µ–Ω—å–≥–∏ –ù–ï –ø–æ—Å—Ç—É–ø–∏–ª–∏ - –ù–ï –ù–ê–ñ–ò–ú–ê–ô–¢–ï –ü–ª–∞—Ç—ë–∂ –ø–æ–ª—É—á–µ–Ω"');
console.log('');
console.log('2. üìû –ö–Ω–æ–ø–∫–∞ "–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É"');
console.log('   - –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É');
console.log('   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–±–æ—Ä—É –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤');
console.log('');
console.log('3. üîí –ó–∞—â–∏—Ç–∞ —ç—Å–∫—Ä–æ—É:');
console.log('   - –¢–æ–∫–µ–Ω—ã –æ—Å—Ç–∞—é—Ç—Å—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
console.log('   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã —Å–¥–µ–ª–∫–∏ —á–µ—Ä–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫—É');
console.log('');
console.log('4. üì∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–±–æ—Ä—É –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤:');
console.log('   - –°–∫—Ä–∏–Ω—à–æ—Ç—ã –ø–µ—Ä–µ–ø–∏—Å–∫–∏');
console.log('   - –î–µ—Ç–∞–ª–∏ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π');

// –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏
console.log('\nüìã –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏');
console.log('-'.repeat(50));

console.log('‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –°–û–ì–õ–ê–°–ù–û –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú:');
console.log('');
console.log('üìù –ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:');
console.log('üí∞ –°–î–ï–õ–ö–ê –°–û–ó–î–ê–ù–ê');
console.log('‚Å†‚Å†‚Å†‚Å†‚Å†‚Å†‚Å†‚Å†‚Å†‚Å†');
console.log('–û—Ä–¥–µ—Ä: CES03288168');
console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1 CES');
console.log('–°—É–º–º–∞: 100.00 ‚ÇΩ');
console.log('');
console.log('üîí –í–∞—à–∏ CES –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã –≤ —ç—Å–∫—Ä–æ—É!');
console.log('üíµ –û–∂–∏–¥–∞–π—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –æ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.');
console.log('');
console.log('‚úÖ –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ–Ω–µ–≥ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–ª–∞—Ç—ë–∂.');
console.log('');
console.log('‚å®Ô∏è –ö–ù–û–ü–ö–ò:');
console.log('   - ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É (–ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –∫–Ω–æ–ø–∫–∞ –≤ –Ω–∞—á–∞–ª–µ)');
console.log('');
console.log('‚ùó –í–ê–ñ–ù–û: –ö–Ω–æ–ø–∫–∞ "–ü–ª–∞—Ç—ë–∂ –ø–æ–ª—É—á–µ–Ω" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û');
console.log('   –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º–µ–π–∫–µ—Ä –Ω–∞–∂–º–µ—Ç "–ü–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω"');

console.log('\nüéâ –ò–¢–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:');
console.log('='.repeat(50));
console.log('‚úÖ 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏');
console.log('‚úÖ 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "payment_made"');
console.log('‚úÖ 3. –°–æ–∑–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏');
console.log('‚úÖ 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ü–ª–∞—Ç—ë–∂ –ø–æ–ª—É—á–µ–Ω" –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç');
console.log('‚úÖ 5. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞');
console.log('‚úÖ 6. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏');
console.log('‚úÖ 7. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä');
console.log('');
console.log('üöÄ –í–°–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í–´–ü–û–õ–ù–ï–ù–´!');
console.log('üì± –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ');